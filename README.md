### МТУСИ ВВИТ ЕГОРОВ ЗИНАТУЛЛИН 2025
# [ Packet loss lab ]

### Разбираемся с заданием и ставим цель
И так. У нас есть задание:
![Some img](https://github.com/Frysuni/packet-loss-lab/blob/main/assets/img1.png)
Это все что у нас есть, ведь я успел забыть что это все значит.

Рассмотрим подробнее.
Основной блок подписан снизу как Docker, в нем есть еще 4 блока, подписанных как: NET CONP (+UI!), Stream NET, Nginx (HLS+UI), VNC STR.

Расставим все по полочкам.

Во-первых нам нужен VNC Desktop контейнер, где будут установлены VLC, FFMPEG, GSTREAMER. Возможно на рабочий стол нужно будет положить ярлыки для просмотра видео из других контейнеров.

Во-вторых нужен Nginx сервер, который будет раздавать какой-либо видеопоток.
HLS + UI. HLS это протокол, понятно. UI ..? Имеется ввиду панель управления бэкендом или html страница? Чтожшж, html будет проще, будем считать что имелся ввиду именно он.

В-третьих самое основное, контейнер, который будет портить трафик, исходящий из nginx сервера, симулируя реальную потерю пакетов. Его можно настроить на 3G, WiFi, процентное соотношение, ограничение трафика.

И все это объединено внутренней сетью докера для общения контейнеров друг с другом, при этом каждый контейнер так же доступен в сети хоста (или публичной).

#### Сделано. Рассказываю:
![Some another img](https://github.com/Frysuni/packet-loss-lab/blob/main/assets/img2.png)
Вот так выглядит конечная структура файлов.
В корне у нас есть .env и docker-compose.yaml. В Env указаны порты подключения и пароль vnc. compose.yaml создает внутреннюю сеть и объединяет остальные compose файлы, которые объявлены уже для каждого сервиса.

##### vnc-gui сервис
Desktop сделан на базе ubuntu 22 и пакета ubuntu-desktop-minimal. VNC сервер запущен с помощью tightvncserver. Так же установлены пакеты, такие как vlc, ffmpeg, gstreamer. Более ничего с этим сервером не делалось. Подключение к нему настраивается в .env

##### nginx-hls-streamer
есть директория public, которая смонтирована в контейнер и прописана в nginx.conf(тоже смонтирован через volume). convert.sh - простой скрипт, кототрый с помощью ffmpeg конвертирует mp4 в видео hls формата. Порт так же настроен в .env и контейнер подключен к внешней и внутренней сети. Так же в public лежит index.html, который подключает hls.js библиотеку из интернета для воспроизведения видео не только в safari браузере.

##### netem-proxy
Портит трафик, проходящий через него. Сделано через tc библиотеку, использует модуль netem (Network Emulation). Через bash скрипт настроены профили (wifi, 3g, etc), которые указываются в dotenv. как прокси использует socat (самый простой и рабочий вариант).
Важно отметить, что предыдущий контейнер раздаёт видео по TCP (hls это http, http это tcp), следственно потери мы заметим только в виде замедленной загрузки видео по чанкам (в случае, если видео будет идти быстрее, чем чанк загрузится)